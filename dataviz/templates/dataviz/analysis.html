{% extends "dataviz/base.html" %}
<!DOCTYPE html>
<!-- Updated analysis.html -->
{% load static %}

{% block meta %}
<meta name="robots" content="noindex, follow">
{% endblock %}


{% block extra_head %}
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
{% endblock %}

{% block content %}
<h1 class="mb-4 text-center">ðŸ“Š Data Analysis & Visualization Dashboard</h1>
<p class="lead text-center mb-5">Upload your data or select a sample dataset to generate interactive insights and plots.</p>

{% if error %}
<div class="alert alert-danger"><strong>Error:</strong> {{ error }}</div>
{% endif %}

{% if info %}
<div class="alert alert-info"><strong>Info:</strong> {{ info }}</div>
{% endif %}

<!-- Data Source Card -->
<div class="card shadow-lg mb-5">
  <div class="card-header bg-primary text-white"><h5 class="mb-0">Data Source Selection</h5></div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-6 border-end">
        <form method="POST" class="d-flex align-items-center">{% csrf_token %}
          <label class="form-label me-3 mb-0">Choose a sample dataset:</label>
          <select class="form-select me-3" name="dataset_select">
            {% for dataset in dataset_options %}
            <option value="{{ dataset }}" {% if dataset == selected_dataset %}selected{% endif %}>{{ dataset|capfirst }}</option>
            {% endfor %}
          </select>
          <button class="btn btn-success">Load Sample</button>
        </form>
      </div>

      <div class="col-md-6">
        <form method="POST" enctype="multipart/form-data" class="d-flex align-items-center">{% csrf_token %}
          <label class="form-label me-3 mb-0">Upload CSV/XLSX:</label>
          <input class="form-control me-3" type="file" name="file_upload" accept=".csv,.xlsx" required>
          <button class="btn btn-warning">Upload</button>
        </form>
      </div>
    </div>

    {% if selected_dataset %}
    <p class="mt-3 text-success">âœ… Loaded '{{ selected_dataset|capfirst }}' dataset.</p>
    {% elif uploaded_file_name %}
    <p class="mt-3 text-success">âœ… Uploaded '{{ uploaded_file_name }}' successfully!</p>
    {% endif %}
  </div>
</div>

{% if overview %}
<section id="data-overview" class="mb-5">
  <h2 class="mb-4 text-primary">Dataset Overview</h2>

  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light"><h5>Dataset Shape & Preview</h5></div>
        <div class="card-body">
          <p><strong>Rows:</strong> {{ overview.shape.0 }}</p>
          <p><strong>Columns:</strong> {{ overview.shape.1 }}</p>
          <h6 class="mt-3">First 5 Rows:</h6>
          {{ overview.preview|safe }}
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light"><h5>Column Data Types</h5></div>
        <div class="card-body overflow-auto" style="max-height:300px;">
          {{ overview.dtypes|safe }}
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light"><h5>Missing Values</h5></div>
        <div class="card-body overflow-auto" style="max-height:300px;">
          {% if overview.missing_values %}
          {{ overview.missing_values|safe }}
          {% else %}
          <div class="alert alert-success">No missing values.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light"><h5>Summary Statistics</h5></div>
        <div class="card-body overflow-auto" style="max-height:300px;">
          {% if overview.summary_stats %}
          {{ overview.summary_stats|safe }}
          {% else %}
          <div class="alert alert-warning">No numeric columns.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Correlation Heatmap -->
<div class="card shadow-lg mb-5">
  <div class="card-header bg-secondary text-white"><h5>Correlation Heatmap</h5></div>
  <div class="card-body text-center">
    {% if heatmap_html %}{{ heatmap_html|safe }}
    {% elif heatmap_error %}<div class="alert alert-warning">{{ heatmap_error }}</div>
    {% else %}<div class="alert alert-info">No numeric columns.</div>
    {% endif %}
  </div>
</div>

<!-- Pairplot -->
<div class="card shadow-lg mb-5">
  <div class="card-header bg-secondary text-white"><h5>Pairplot</h5></div>
  <div class="card-body text-center">
    <form method="POST" class="mb-4 d-flex justify-content-center align-items-center">{% csrf_token %}
      <label class="form-label me-3 mb-0">Hue:</label>
      <select class="form-select w-auto me-3" name="hue_col_select">
        <option value="None">None</option>
        {% for col in all_columns %}
        <option value="{{ col }}" {% if col == hue_col %}selected{% endif %}>{{ col }}</option>
        {% endfor %}
      </select>
      <button class="btn btn-info">Update</button>
    </form>

    {% if pairplot_img %}
    <img src="data:image/png;base64,{{ pairplot_img }}" class="img-fluid rounded shadow-sm">
    {% elif pairplot_error %}
    <div class="alert alert-warning">{{ pairplot_error }}</div>
    {% endif %}
  </div>
</div>

<!-- Interactive Plot -->
<div class="card shadow-lg mb-5">
  <div class="card-header bg-secondary text-white"><h5>Interactive Column Plot</h5></div>
  <div class="card-body text-center">
    {% if numeric_columns %}
    <form method="POST" class="mb-4 d-flex justify-content-center flex-wrap">{% csrf_token %}

      <label class="form-label me-3 mb-0">X-axis:</label>
      <select class="form-select w-auto me-3" name="x_col_select">
        {% for col in numeric_columns %}
        <option value="{{ col }}" {% if col == x_col %}selected{% endif %}>{{ col }}</option>
        {% endfor %}
      </select>

      <label class="form-label me-3 mb-0">Y-axis:</label>
      <select class="form-select w-auto me-3" name="y_col_select">
        {% for col in numeric_columns %}
        <option value="{{ col }}" {% if col == y_col %}selected{% endif %}>{{ col }}</option>
        {% endfor %}
      </select>

      <label class="form-label me-3 mb-0">Plot Type:</label>
      <select class="form-select w-auto me-3" name="plot_type_select">
        {% for type in chart_types %}
        <option value="{{ type }}" {% if type == plot_type %}selected{% endif %}>{{ type }}</option>
        {% endfor %}
      </select>

      <button class="btn btn-info">Generate</button>
    </form>

    {% if interactive_plot_img %}
    <img src="data:image/png;base64,{{ interactive_plot_img }}" class="img-fluid rounded shadow-sm">
    {% elif interactive_plot_error %}
    <div class="alert alert-warning">{{ interactive_plot_error }}</div>
    {% endif %}

    {% else %}
    <div class="alert alert-info">No numeric columns available.</div>
    {% endif %}
  </div>
</div>

{% endif %}

{% endblock %}
